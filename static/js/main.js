// Generated by CoffeeScript 1.8.0
(function() {
  (function($) {
    var init_map, latitude, load_carparks, load_history, load_user, longitude, map, register, token;
    token = localStorage.getItem('token');
    latitude = 47.3824883072708;
    longitude = 8.54028777940725;
    map = null;
    load_user = function() {
      return $.ajax({
        url: '/users/details',
        type: 'GET',
        data: {
          token: token
        },
        contentType: 'application/json',
        success: function(data) {
          $("#navbar-login").hide();
          $("#navbar-user").show();
          $("#navbar-user").removeClass('hidden');
          $(".content").hide();
          $("#content-history").show();
          $('#account-name').val(data.user.name);
          $('#account-email').val(data.user.email);
          return load_history();
        },
        error: function() {
          token = null;
          return localStorage.removeItem('token');
        }
      });
    };
    load_carparks = function() {
      var center;
      $(map.markers).each(function(i, marker) {
        return marker.setMap(null);
      });
      center = map.getCenter();
      return $.ajax({
        url: '/carparks',
        type: 'GET',
        data: {
          token: token,
          longitude: center.lng(),
          latitude: center.lat()
        },
        success: function(data) {
          return $(data.carparks).each(function(i, carpark) {
            return map.addMarker({
              lng: carpark.longitude,
              lat: carpark.latitude,
              title: carpark.name,
              infoWindow: {
                content: "<h5>" + carpark.name + "</h5><img src=\"" + carpark.image + "\"><br>Parking spots: " + carpark.free + "/" + carpark.capacity + "<br>Cost: CHF " + (carpark.cost / 100) + " / h<br>" + carpark.address
              }
            });
          });
        },
        error: function(r) {
          console.log(r);
          return console.log(r.responseJSON.error);
        }
      });
    };
    register = function() {
      $.ajax({
        url: '/users/register',
        type: 'POST',
        data: JSON.stringify({
          email: $('#registration-email').val(),
          password: $('#registration-password').val(),
          name: $('#registration-name').val(),
          creditcard: $('#registration-creditcard').val()
        }),
        contentType: 'application/json',
        success: function(data) {
          token = data.user.token;
          localStorage.setItem('token', token);
          load_user();
          return $('#registration').modal('hide');
        },
        error: function(data) {
          $('#login-error-text').html(data.responseJSON.error);
          return $('#login-error').modal();
        }
      });
      return false;
    };
    load_history = function() {
      return $.ajax({
        url: '/users/checkins',
        type: 'GET',
        data: {
          token: token
        },
        contentType: 'application/json',
        success: function(data) {
          var table, tbody;
          table = $("#history-table");
          tbody = table.find('tbody');
          tbody.html('');
          return $(data.checkins).each(function(i, checkin) {
            return tbody.append($("<tr><td><img src=\"" + checkin.carpark.image + "\"></td><td>" + checkin.carpark.name + "</td><td>" + checkin.checkin + "</td><td>" + checkin.checkout + "</td><td>" + checkin.duration + " min</td><td>" + (checkin.cost / 100) + " CHF</td></tr>"));
          });
        },
        error: function() {
          token = null;
          return localStorage.removeItem('token');
        }
      });
    };
    init_map = function() {
      $(".content").hide();
      $("#content-map").show();
      map = new GMaps({
        div: '#map',
        lat: latitude,
        lng: longitude,
        dragend: load_carparks
      });
      return load_carparks();
    };
    if (map != null) {
      GMaps.geolocate({
        success: function(position) {
          latitude = position.coords.latitude;
          longitude = position.coords.longitude;
          return map.setCenter(latitude, longitude);
        },
        error: function(error) {
          return $('#map-error').modal();
        }
      });
    }
    if (token != null) {
      load_user();
    }
    $("#login-form").submit(function() {
      $.ajax({
        url: '/users/login',
        type: 'POST',
        data: JSON.stringify({
          email: $("#login-email").val(),
          password: $("#login-password").val()
        }),
        contentType: 'application/json',
        success: function(data) {
          token = data.user.token;
          localStorage.setItem('token', token);
          return load_user();
        }
      });
      return false;
    });
    $('#registration-form').submit(function() {
      return register();
    });
    $('#registration-submit').click(function() {
      return $('#registration-form').submit();
    });
    $('#navbar-register').click(function() {
      return $('#registration').modal();
    });
    $(".content").hide();
    $("#content-intro").show();
    $("#navbar-account").click(function() {
      $(".content").hide();
      $("#content-account").show();
      return false;
    });
    $("#navbar-history").click(function() {
      $(".content").hide();
      $("#content-history").show();
      load_history();
      return false;
    });
    $("#navbar-map").click(function() {
      init_map();
      return false;
    });
    $('#search-form').submit(function() {
      init_map();
      GMaps.geocode({
        address: $('#search-address').val(),
        callback: function(results, status) {
          var latlng;
          if (status === 'OK') {
            latlng = results[0].geometry.location;
            latitude = latlng.lat();
            longitude = latlng.lng();
            map.setCenter(latlng.lat(), latlng.lng());
            return load_carparks();
          }
        }
      });
      return false;
    });
    return $('#account-form').submit(function() {
      var data;
      data = {
        token: token,
        email: $('#account-email').val(),
        name: $('#account-name').val()
      };
      if ($('#account-password').val() != null) {
        data.password = $('#account-password').val();
      }
      if ($('#account-creditcard').val() != null) {
        data.creditcard = $('#account-creditcard').val();
      }
      $.ajax({
        url: '/users/update',
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        success: function(data) {
          return load_user();
        }
      });
      return false;
    });
  })(jQuery);

}).call(this);

//# sourceMappingURL=main.js.map
